{% extends "base_header.html" %}
{% block title %}Helpdesk | {{ action.name }}{% endblock %}

{#
{% macro render_action_tree(tree) %}
      <div class="list-group">
        <label class="label label-default">{{ tree.name }}</label>
    {% for sub in tree.nexts %}
        {% if sub.action %}
        <a class="list-group-item" href="{{ url_for('web:index', full_path=sub.action.target_object) }}" title="{{ sub.action.desc }}">{{ sub.action.name }}</a>
        {% endif %}
        {% if sub.nexts %}
            {{ render_action_tree(sub) }}
        {% endif %}
    {% endfor %}
      </div>
{%- endmacro %}
#}

{% block container %}
<a-layout>
  <a-row>

    <a-col :md="6">
		<a-layout-sider width="200" style="background: #fff">
            <h-menu data="{{ menu_data }}"></h-menu>
            {#
            {% for sub in action_tree.nexts %}
              {{ render_action_tree(sub) }}
            {% endfor %}
            #}
		</a-layout-sider>
    </a-col>

    <a-col :md="18">
		<a-layout>
		<a-layout-content>
        <h3>{{ action.name }}</h3>
        <hr />
        {% if msg %}
        <div class="alert alert-{{ msg_level }}">
            <p>{% autoescape false %}{{ msg }}{% endautoescape %}</p>
        </div>
        {% endif %}
        <div class="alert alert-info">
            <p>{{ action.desc }}</p>
        </div>

        <form action="" method="POST" class="form-horizontal">
            {% for name, param_property in action.parameters(provider).items() %}
                {{ render_param(name, param_property) }}
            {% endfor %}
            <div class="form-group">
                <div class="col-sm-offset-2 col-sm-6">
                    <button type="submit" class="btn btn-primary">提交</button>
                </div>
            </div>
        </form>

        {% if debug and request.user.is_admin %}
        <div v-pre class="alert alert-info">
            <p>action: {{ action.get_action(provider)|tojson }}</p>
            {% if execution %}
            <p>execution: {{ execution|tojson }}</p>
            {% endif %}
            {% if ticket %}
            <p>ticket: {{ ticket|tojson }}</p>
            {% endif %}
        </div>
        {% endif %}

		</a-layout-content>
		</a-layout>
    </a-col>

  </a-row>
</a-layout>
{% endblock container %}

{% macro render_param(name, property) %}
    {% if not property['immutable'] %}
    <div class="form-group">
        <label class="col-sm-2 control-label">{{ name }}</label>
        <div class="col-sm-6">

            {% if property['type'] == 'boolean' %}
            <div class="checkbox">
                <label><input type="checkbox" name="{{ name }}"></label>
            </div>
            {% else %}

            {% if not property['enum'] %}
            <textarea class="form-control" name="{{ name }}"
                rows="1"
                placeholder="{% if property['required'] %}required{% else %}optional{% endif %}"
                required="{% if property['required'] %}required{% else %}{% endif %}"></textarea>
            {% else %}
            <select name="{{ name }}" class="form-control">
                {% for choice in property['enum'] %}
                <option value="{{ choice }}">{{ choice }}</option>
                {% endfor %}
            </select>
            {% endif %}

            {% endif %}

            <span class="help-block">{{ property['description'] }}</span>

        </div>
    </div>
    {% endif %}
{% endmacro %}

{% block extra_js %}
<script type="text/javascript" src="{{ url_for('static', path='/chosen/chosen.jquery.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', path='/js/bootstrap3-typeahead.min.js') }}"></script>
<script type="text/javascript">
$(function() {
    $(".chosen-select").chosen();
    $("[rel='tooltip']").tooltip();
});
</script>

{% macro render_action_tree2(tree, level=1) %}
    <a-sub-menu key="{{ '%s-%s' % (level, tree.name) }}">
      <span slot="title"><a-icon type="folder" /><span>{{ tree.name }}</span></span>
    {% for sub in tree.nexts %}
      {% if sub.action %}
      <a-menu-item key="{{ sub.action.name }}">
        <a href="{{ url_for('web:index', full_path=sub.action.target_object) }}" title="{{ sub.action.desc }}"></a>
      {{ sub.action.name }}
      </a-menu-item>
      {% endif %}
      {% if sub.nexts %}
        {{ render_action_tree2(sub, level+1) }}
      {% endif %}
    {% endfor %}
    </a-sub-menu>
{%- endmacro %}

<script type="text/x-template" id="menu-template">
  <a-menu
    mode="inline"
    :openKeys="openKeys"
    :defaultSelectedKeys="selectedKeys"
    @openChange="onOpenChange"
    :style="{ height: '100%', borderRight: 0 }"
  >
    <a-menu-item key="{{ action_tree.name }}">
	    {{ action_tree.name }}
    </a-menu-item>
    {% for sub in action_tree.nexts %}
      {{ render_action_tree2(sub) }}
    {% endfor %}
  </a-menu>
</script>

<script type="text/javascript">
Vue.component('h-menu', {
  props: ['data'],
  data: function () {
    return JSON.parse(this.data)
  },
  methods: {
    onOpenChange (openKeys) {
      const latestOpenKey = openKeys.find(key => this.openKeys.indexOf(key) === -1)
      if (!latestOpenKey || this.openKeys.length === 0) {
          this.openKeys = openKeys
          return
      }
      if (this.openKeys[this.openKeys.length-1].split('-')[0] == latestOpenKey.split('-')[0]) {
        this.openKeys.pop()
      }
      this.openKeys.push(latestOpenKey)
      console.log(openKeys + ', ' + this.openKeys + ', ' + latestOpenKey)
    },
  },  
  template: '#menu-template'
})

new Vue({
  el: '#app',
  data: {
  },
})
</script>

<script type="text/javascript" src="{{ url_for('static', path='/js/autosize.js') }}"></script>
<script>
$(function() {
  autosize($('textarea'));
});

</script>
{% endblock extra_js %}
