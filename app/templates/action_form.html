{% extends "base_header.html" %}
{% block title %}Helpdesk | {{ action.name }}{% endblock %}

{#
{% macro render_action_tree(tree) %}
      <div class="list-group">
        <label class="label label-default">{{ tree.name }}</label>
    {% for sub in tree.nexts %}
        {% if sub.action %}
        <a class="list-group-item" href="{{ url_for('web:index', full_path=sub.action.target_object) }}" title="{{ sub.action.desc }}">{{ sub.action.name }}</a>
        {% endif %}
        {% if sub.nexts %}
            {{ render_action_tree(sub) }}
        {% endif %}
    {% endfor %}
      </div>
{%- endmacro %}
#}

{% block container %}
<a-layout style="padding: 0 24px 24px">

    <a-layout-sider width="300" style="background: #fff">
        <h-menu data="{{ menu_data }}"></h-menu>
        {#
        {% for sub in action_tree.nexts %}
          {{ render_action_tree(sub) }}
        {% endfor %}
        #}
    </a-layout-sider>

    <a-layout-content
        :style="{ background: '#fff', padding: '24px', margin: '0 0 0 24px', minHeight: '280px' }"
    >
    <a-divider orientation="left"><h3>{{ action.name }}</h3></a-divider>
    {% if msg %}
    {# FIXME: a-alert message allow html
    <a-alert
      message="{% autoescape false %}{{ msg }}{% endautoescape %}"
      type="{{ msg_level }}"
      :style="{ margin: '16px' }"
      closable
    >
    </a-alert>
    #}
    <div data-show="true" class="ant-alert ant-alert-{{ msg_level }} ant-alert-no-icon" style="margin: 16px;">
        {% autoescape false %}{{ msg }}{% endautoescape %}
    </div>
    {% endif %}
    <a-alert
      message="{{ action.desc or action.description(provider) }}"
      type="info"
      :style="{ margin: '16px' }"
    >
    </a-alert>

    <h-form></h-form>

    {% if request.user.is_admin %}
    <h-drawer></h-drawer>
    {% endif %}

    </a-layout-content>
</a-layout>
{% endblock container %}

{% macro render_param(name, property) %}
    {% if not property['immutable'] %}
    <a-form-item label="{{ name }}"
      :label-col="{ span: 5 }"
      :wrapper-col="{ span: 12 }"
      extra="{{ property['description'] }}"
    >

        {% if property['type'] == 'boolean' %}
            <a-checkbox name="{{ name }}"></a-checkbox>
        {% elif property['enum'] %}
            <v-select
                name="{{ name }}"
                :options="{{ property['enum'] }}"
                :multiple="true"
                :clearable="true"
                :searchable="true"
                :filterable="true"
                :taggable="true"
                :select-on-tab="true"
                @keypress.enter.native.prevent=""
                v-model="selectedValues['{{ name }}']"
            ></v-select>
            <input type='hidden' name="{{ name }}" :value="selectedValues['{{ name }}']" />

            {#
            <a-select
            mode="multiple"
            style="width: 100%"
            :tokenSeparators="[',']"
            {% if property['required'] %}
            v-decorator="[
              '{{ name }}',
              {rules: [{ required: true, message: 'This field is required!' }]}
            ]"
            {% endif %}
            v-model="selectedValues['{{ name }}']"
            >
                {% for choice in property['enum'] %}
                <a-select-option key="{{ choice }}">{{ choice }}</a-select-option>
                {% endfor %}
            </a-select>
            #}

        {% else %}
            <a-textarea name="{{ name }}"
                rows="1"
                placeholder="{% if property['required'] %}required{% else %}optional{% endif %}"
                autosize
                required="{% if property['required'] %}required{% else %}{% endif %}"
                {% if property['required'] %}
                v-decorator="[
                  '{{ name }}',
                  {rules: [{ required: true, message: 'This field is required!' }]}
                ]"
                {% endif %}
            ></a-textarea>
        {% endif %}

    </a-form-item>
    {% endif %}
{% endmacro %}

{% block extra_js %}
<script type="text/javascript" src="{{ url_for('static', path='/chosen/chosen.jquery.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', path='/js/bootstrap3-typeahead.min.js') }}"></script>
<script type="text/javascript">
$(function() {
    $(".chosen-select").chosen();
    $("[rel='tooltip']").tooltip();
});
</script>

{% macro render_action_tree2(tree, level=1) %}
    <a-sub-menu key="{{ '%s-%s' % (level, tree.name) }}">
      <span slot="title"><a-icon type="folder" /><span>{{ tree.name }}</span></span>
    {% for sub in tree.nexts %}
      {% if sub.action %}
      <a-menu-item key="{{ sub.action.name }}">
        <a href="{{ url_for('web:index', full_path=sub.action.target_object) }}" title="{{ sub.action.desc }}"></a>
      {{ sub.action.name }}
      </a-menu-item>
      {% endif %}
      {% if sub.nexts %}
        {{ render_action_tree2(sub, level+1) }}
      {% endif %}
    {% endfor %}
    </a-sub-menu>
{%- endmacro %}

<script type="text/x-template" id="menu-template">
  <a-menu
    mode="inline"
    :openKeys="openKeys"
    :defaultSelectedKeys="selectedKeys"
    @openChange="onOpenChange"
    :style="{ height: '100%', borderRight: 0 }"
  >
    <a-menu-item v-if="false">
        <a-input-search placeholder="Search" @change="onSearchChange" />
    </a-menu-item>
    <a-menu-item key="{{ action_tree.name }}">
        <a href="/">{{ action_tree.name }}</a>
    </a-menu-item>
    {% for sub in action_tree.nexts %}
      {{ render_action_tree2(sub) }}
    {% endfor %}
  </a-menu>
</script>

<script type="text/x-template" id="form-template">
  <a-form key="h-form" action="" method="POST"
  	@submit="handleSubmit"
  >
      {% for name, param_property in action.parameters(provider).items() %}
          {{ render_param(name, param_property) }}
      {% endfor %}
      <a-form-item
          :wrapper-col="{ span: 12, offset: 5 }"
      >
          <a-button
            type="primary"
            html-type="submit"
          >
            Submit
          </a-button>
      </a-form-item>
  </a-form>
</script>

<script type="text/x-template" id="drawer-template">
<div>
  <a-drawer
    key="h-drawer"
    title="Admin Panel"
    :width="720"
    placement="right"
    :closable="false"
    @close="onClose"
    :visible="visible"
  >
    <div slot="handle" class="ant-pro-setting-drawer-handle" @click="showDrawer">
      <a-icon type="setting" :style="{color: '#fff', fontSize: '20px'}"/>
    </div>

    {% raw %}
    <a-form v-for="(param_rule, index) in param_rules"
        :key="index"
        method="POST"
        layout="vertical"
        hideRequiredMark
        @submit="(e) => onSubmit(e, index)"
    >
        <a-row :gutter="16">
            <a-col>
                <a-form-item label="Title">
                    <a-input name="title" placeholder="Untitled"
                        v-model="param_rule.title"
                    ></a-input>
                </a-form-item>
            </a-col>
        </a-row>
        <a-row :gutter="16">
            <a-col>
                <a-form-item label="Rule">
                    <a-textarea name="rule"
                        rows="1"
                        placeholder='e.g. ["onlycontains", ["split", "hosts", ","], "***REMOVED***", "***REMOVED***", "***REMOVED***"]'
                        autosize
                        required="true"
                        v-model="param_rule.rule"
                    ></a-textarea>
                </a-form-item>
            </a-col>
        </a-row>
        <a-row :gutter="16">
            <a-col :span="6">
                <a-form-item label="Is auto-approval?">
                    <a-checkbox name="is_auto_approval"
                        :checked="param_rule.is_auto_approval"
                        @change="(e) => onCheckboxChange(e, index, 'is_auto_approval')"
                    ></a-checkbox>
                </a-form-item>
            </a-col>
            <a-col :span="18">
                <a-form-item label="Approver">
                    <a-input name="approver" placeholder="Approver names seperated by comma"
                        v-model="param_rule.approver"
                    ></a-input>
                </a-form-item>
            </a-col>
        </a-row>

            <a-form-item :style="{textAlign: 'right'}"
            >
                <a-button type="danger" shape="circle" icon="close"
                    :style="{marginRight: '8px'}"
                    :disabled="param_rules.length - 1 === index"
                    @click="(e) => onDelete(e, index)"
                />
                <a-button html-type="submit" type="primary" shape="circle" icon="check" />
            </a-form-item>

        <a-divider />
    </a-form>
    {% endraw %}

    {% if debug and request.user.is_admin %}
    <div>
      <a-collapse accordion :bordered="false">
        <a-collapse-panel header="Debug Info" key="1">
          <div v-pre>
            <p>action: {{ action.get_action(provider)|tojson }}</p>
            {% if execution %}
            <p>execution: {{ execution|tojson }}</p>
            {% endif %}
            {% if ticket %}
            <p>ticket: {{ ticket|tojson }}</p>
            {% endif %}
          </div>
        </a-collapse-panel>
      </a-collapse>
    </div>
    {% endif %}

  </a-drawer>
</div>
</script>

<script type="text/javascript">
Vue.component('h-menu', {
  props: ['data'],
  data: function () {
    return JSON.parse(this.data)
  },
  methods: {
    onOpenChange (openKeys) {
      const latestOpenKey = openKeys.find(key => this.openKeys.indexOf(key) === -1)
      if (!latestOpenKey || this.openKeys.length === 0) {
          this.openKeys = openKeys
          return
      }
      if (this.openKeys[this.openKeys.length-1].split('-')[0] == latestOpenKey.split('-')[0]) {
        this.openKeys.pop()
      } else if (latestOpenKey.split('-')[0] == '1') {
          this.openKeys = []
      }
      this.openKeys.push(latestOpenKey)
      // console.log(openKeys + ', ' + this.openKeys + ', ' + latestOpenKey)
    },
    // TODO: search menu
    onSearchChange (e) {
    },
  },
  template: '#menu-template'
})

Vue.component('h-form', {
  props: [],
  data: function () {
      return {
        selectedValues: {},
      }
  },
  methods: {
    handleSubmit (e) {
      // e.preventDefault();
    },
  },
  template: '#form-template'
})

Vue.component('h-drawer', {
  data() {
    return {
      visible: false,
      handle: "handle",
      url_param_rule: "{{ url_for('api:admin_panel', target_object=action.target_object, config_type='param_rule') }}",
      url_param_rule_add: "{{ url_for('api:admin_panel', target_object=action.target_object, config_type='param_rule', op='add') }}",
      url_param_rule_del: "{{ url_for('api:admin_panel', target_object=action.target_object, config_type='param_rule', op='del') }}",
      param_rules: null,
    }
  },
  methods: {
    showDrawer() {
      let this_ = this
      let message = this.$message

      if (!this.param_rules) {
        let xhr = new XMLHttpRequest();
        xhr.responseType = 'json';
        xhr.onreadystatechange = function() {
          if (this.readyState == 4) {
            var jsonResponse = xhr.response;
            if (this.status == 200) {
              this_.param_rules = jsonResponse.data;

              if (!this_.param_rules) {
                  this_.param_rules = []
              }
              // new empty obj
              this_.param_rules.push({})

              // console.log(this_.param_rules)
            } else {
              message.warning(JSON.stringify(jsonResponse));
            }
          }
        };
        xhr.open('GET', this.url_param_rule, true);
        xhr.send();
      }

      this.visible = true
    },
    onClose() {
      this.visible = false
    },
    onCheckboxChange(e, index, attr) {
      var param_rule = this.param_rules[index]
      param_rule[attr] = e.target.checked
      this.param_rules.splice(index, 1, param_rule)
    },
    onSubmit(e, index) {
      e.preventDefault();

      let this_ = this
      let message = this.$message

      let xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.onreadystatechange = function() {
        if (this.readyState == 4) {
          var jsonResponse = xhr.response;
          if (this.status == 200) {
            var param_rule_added = jsonResponse.data
            message.success(JSON.stringify(param_rule_added));
            this_.param_rules.splice(index, 1, param_rule_added)
            // new empty obj if last
            if (this_.param_rules.length - 1 == index) {
                this_.param_rules.push({})
            }
          } else {
            message.warning(JSON.stringify(jsonResponse));
          }
        }
      };
      xhr.open('POST', this.url_param_rule_add, true);
      xhr.setRequestHeader('Content-type', 'application/json')
      xhr.send(JSON.stringify(this.param_rules[index]));

    },
    onDelete(e, index) {
      let this_ = this
      let message = this.$message

      let xhr = new XMLHttpRequest();
      xhr.responseType = 'json';
      xhr.onreadystatechange = function() {
        if (this.readyState == 4) {
          var jsonResponse = xhr.response;
          if (this.status == 200) {
            var param_rule_added = jsonResponse.data
            message.success(JSON.stringify(param_rule_added));
            this_.param_rules.splice(index, 1)
          } else {
            message.warning(JSON.stringify(jsonResponse));
          }
        }
      };
      xhr.open('POST', this.url_param_rule_del, true);
      xhr.setRequestHeader('Content-type', 'application/json')
      xhr.send(JSON.stringify(this.param_rules[index]));
    },

  },
  template: '#drawer-template'
})

// https://vue-select.org
Vue.component('v-select', VueSelect.VueSelect);

// we need ES6
// import { Form } from 'ant-design-vue';
// Vue.use(Form)

new Vue({
  el: '#app',
  data: {
  },
  methods: {
  }
})
</script>
{% endblock extra_js %}
